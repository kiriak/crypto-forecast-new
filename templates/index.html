<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2575.6">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #3874c0; -webkit-text-stroke: #3874c0; background-color: #121313}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 14.0px Menlo; color: #3874c0; -webkit-text-stroke: #3874c0; background-color: #121313; min-height: 16.0px}
    span.s1 {font-kerning: none}
  </style>
</head>
<body>
<p class="p1"><span class="s1">import os</span></p>
<p class="p1"><span class="s1">import logging</span></p>
<p class="p1"><span class="s1">from flask import Flask, render_template, request, jsonify, make_response</span></p>
<p class="p1"><span class="s1">import datetime</span></p>
<p class="p1"><span class="s1">from plotly.offline import plot</span></p>
<p class="p1"><span class="s1">import plotly.graph_objects as go</span></p>
<p class="p1"><span class="s1">import pandas as pd</span></p>
<p class="p1"><span class="s1">import time</span></p>
<p class="p1"><span class="s1">import requests</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"># Assuming crypto_forecast is a module in the same directory</span></p>
<p class="p1"><span class="s1"># from crypto_forecast import get_crypto_data, generate_forecast_plot</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"># Placeholder functions for get_crypto_data and generate_forecast_plot</span></p>
<p class="p1"><span class="s1"># In your actual project, these would be imported from the crypto_forecast.py file</span></p>
<p class="p1"><span class="s1"># For this example, we will use placeholders to ensure the Flask app is runnable</span></p>
<p class="p1"><span class="s1">def get_crypto_data(symbol='BTC-USD'):</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>"""</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Simulates fetching crypto data for a given symbol.</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>In a real app, this would get data from an API.</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>"""</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>logging.info(f"Simulating data fetch for {symbol}...")</span></p>
<p class="p2"><span class="s1"><span class="Apple-converted-space">    </span></span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span># Simple check for a valid symbol</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if symbol not in ['BTC-USD', 'ETH-USD', 'DOGE-USD', 'SOL-USD', 'ADA-USD']:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return pd.DataFrame() # Return empty DataFrame if symbol is invalid</span></p>
<p class="p2"><span class="s1"><span class="Apple-converted-space">        </span></span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span># Generate some dummy data for demonstration</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>dates = pd.to_datetime(pd.date_range(start='2023-01-01', periods=100, freq='D'))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>prices = [100 + i * 2 * (1 + 0.1 * (i % 10)) for i in range(100)]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>df = pd.DataFrame({'ds': dates, 'y': prices})</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return df</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">def generate_forecast_plot(data, symbol='BTC-USD'):</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>"""</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Simulates generating a Plotly forecast plot.</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>"""</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>logging.info(f"Simulating forecast plot generation for {symbol}...")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>fig = go.Figure()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>fig.add_trace(go.Scatter(x=data['ds'], y=data['y'], mode='lines', name='Historical Prices'))</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span># Add a simple forecast line</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>forecast_dates = pd.to_datetime(pd.date_range(start=data['ds'].iloc[-1], periods=30, freq='D'))</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>forecast_prices = [data['y'].iloc[-1] * (1 + 0.01 * i) for i in range(30)]</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>fig.add_trace(go.Scatter(x=forecast_dates, y=forecast_prices, mode='lines', name='Forecast', line=dict(dash='dash')))</span></p>
<p class="p2"><span class="s1"><span class="Apple-converted-space">    </span></span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>fig.update_layout(</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>title=f'{symbol} Price Forecast',</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>xaxis_title='Date',</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>yaxis_title='Price (USD)',</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>template='plotly_white',</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>xaxis_rangeslider_visible=True,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return fig</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"># Configure logging</span></p>
<p class="p1"><span class="s1">logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')</span></p>
<p class="p1"><span class="s1">logging.info("Starting Flask application...")</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">app = Flask(__name__, template_folder='templates')</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"># Check if required environment variables are set</span></p>
<p class="p1"><span class="s1">if not os.environ.get("RENDER"):</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>logging.warning("Not running on Render. Using a default port.")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PORT = 8080</span></p>
<p class="p1"><span class="s1">else:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>logging.info("Running on Render. Using PORT environment variable.")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>PORT = os.environ.get("PORT", 10000)</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">def create_error_plot(error_message):</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>"""</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Creates a simple Plotly figure with an error message.</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>"""</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>fig = go.Figure()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>fig.add_annotation(</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>text=f"Error: {error_message}",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>xref="paper",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>yref="paper",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>showarrow=False,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>font=dict(size=20, color="red")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>fig.update_layout(</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>title_text="Plot Generation Error",</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>xaxis_showgrid=False,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>yaxis_showgrid=False,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>xaxis_visible=False,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>yaxis_visible=False</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return fig</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">@app.route('/', methods=['GET'])</span></p>
<p class="p1"><span class="s1">def index():</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>"""</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Handles the initial request for the main page.</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Renders the index.html template without a plot initially.</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>"""</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>logging.info("Request for the main page ('/'). Rendering index.html.")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>now = datetime.datetime.now()</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>last_updated_time = now.strftime("%Y-%m-%d %H:%M:%S")</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>return render_template(</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>'index.html',</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>plot_html=None,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>last_updated=last_updated_time,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>current_coin='BTC-USD'</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>)</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">@app.route('/forecast', methods=['POST'])</span></p>
<p class="p1"><span class="s1">def forecast():</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>"""</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>Handles the POST request to generate a forecast.</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>It receives the coin symbol from the frontend, generates the plot,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>and returns the plot's HTML as a JSON response.</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>"""</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>logging.info("Request for a new forecast received.")</span></p>
<p class="p2"><span class="s1"><span class="Apple-converted-space">    </span></span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span># Get the coin symbol from the JSON request</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>selected_coin = request.json.get('coin_symbol', 'BTC-USD')</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>logging.info(f"Generating forecast for: {selected_coin}")</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>try:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span># Step 1: Get the data</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span># This function would be imported from crypto_forecast.py</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>data = get_crypto_data(symbol=selected_coin)</span></p>
<p class="p2"><span class="s1"><span class="Apple-converted-space">        </span></span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>if data is None or data.empty:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>error_message = f"Δεν βρέθηκαν δεδομένα για το σύμβολο: {selected_coin}. Παρακαλώ δοκιμάστε ένα άλλο σύμβολο."</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>logging.error(error_message)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>fig = create_error_plot(error_message)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>plot_html = plot(fig, output_type='div', include_plotlyjs=True, config={'displayModeBar': False})</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return jsonify({'plot_html': plot_html, 'error': error_message})</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>else:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span># Step 2: Generate the plot</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span># This function would be imported from crypto_forecast.py</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>fig = generate_forecast_plot(data, symbol=selected_coin)</span></p>
<p class="p2"><span class="s1"><span class="Apple-converted-space">            </span></span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span># Step 3: Convert the plot to HTML</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>plot_html = plot(</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>fig,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>output_type='div',</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>include_plotlyjs=True,</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">                </span>config={'displayModeBar': False}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>logging.info("Η HTML του γραφήματος δημιουργήθηκε με επιτυχία.")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>return jsonify({'plot_html': plot_html, 'error': None})</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>except Exception as e:</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span># Catch any errors during the process and return an error plot</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>logging.error(f"Σφάλμα κατά τη δημιουργία του γραφήματος: {e}")</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>error_message = str(e)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>fig = create_error_plot(error_message)</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>plot_html = plot(fig, output_type='div', include_plotlyjs=True, config={'displayModeBar': False})</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>return jsonify({'plot_html': plot_html, 'error': error_message})</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">if __name__ == '__main__':</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span># Run the Flask app on the specified port</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>app.run(host='0.0.0.0', port=PORT, debug=False)</span></p>
</body>
</html>
